name: Anjani Kernel Build

on:
  workflow_dispatch:
    inputs:
      repository: { description: 'Repo', required: true, default: 'https://github.com/malkist01/G1.git' }
      branch: { description: 'Branch', required: true, default: 'main' }
      defconfig: { description: 'Defconfig', required: true, default: 'vendor/ginkgo_defconfig' }
      kernelsu_branch: { description: 'KSU Branch', required: false, default: 'master' }

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        repository: ${{ github.event.inputs.repository }}
        ref: ${{ github.event.inputs.branch }}
        submodules: recursive

    - name: Setup and Build
      run: |
        export DEBIAN_FRONTEND=noninteractive
        sudo apt-get update
        sudo apt-get install -y build-essential libncurses-dev bison flex libssl-dev libelf-dev bc zip gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi python3 python-is-python3 git wget curl
        
        export TZ="Asia/Jakarta"
        echo "BUILD_TIME=$(date +'%H%M-%d%m%y')" >> $GITHUB_ENV

        # Download AOSP Clang r563880c
        mkdir tc
        wget -qO- https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/4d2864f08ff2c290563fb903a5156e0504620bbe/clang-r563880c.tar.gz | tar -xz -C tc
        export PATH=$PWD/tc/bin:$PATH
        
        curl -LSs "https://raw.githubusercontent.com/backslashxx/KernelSU/master/kernel/setup.sh" | bash -s ${{ github.event.inputs.kernelsu_branch }}

        export ARCH=arm64
        export KBUILD_BUILD_USER="malkist"
        export KBUILD_BUILD_HOST="android"
        ARGS="O=out ARCH=arm64 CC=clang LD=ld.lld AR=llvm-ar NM=llvm-nm STRIP=llvm-strip OBJCOPY=llvm-objcopy OBJDUMP=llvm-objdump CROSS_COMPILE=aarch64-linux-gnu- CROSS_COMPILE_ARM32=arm-linux-gnueabi- LLVM=1 LLVM_IAS=1"
        
        make $ARGS ${{ github.event.inputs.defconfig }} 2>&1 | tee defconfig.log || true
        make -j$(nproc) $ARGS 2>&1 | tee compile.log || true

        if [ -f out/arch/arm64/boot/Image.gz ]; then
          ZIP_NAME="AnjaniLaurens-${{ env.BUILD_TIME }}.zip"
          zip -j "$ZIP_NAME" out/arch/arm64/boot/Image out/arch/arm64/boot/dtbo.img 2>/dev/null || zip -j "$ZIP_NAME" out/arch/arm64/boot/Image.gz
          echo "FINAL_ZIP=$ZIP_NAME" >> $GITHUB_ENV
        fi

    - name: Upload Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: Build-Result-${{ env.BUILD_TIME }}
        path: |
          *.log
          *.zip
        retention-days: 7

    - name: Telegram Notification
      if: always()
      run: |
        TOKEN="7868194496:AAGY7WwRRbeCOPYOnczoCPh2psC43Q0F3JI"
        CHAT="-1002287610863"
        
        if [ -f "compile.log" ]; then
          curl -s -F document=@"compile.log" \
               "https://api.telegram.org/bot${TOKEN}/sendDocument" \
               -F chat_id="${CHAT}" \
               -F caption="AnjaniLaurens Log [${{ env.BUILD_TIME }}] - Status: ${{ job.status }}"
        fi

        if [ -f "${{ env.FINAL_ZIP }}" ]; then
          curl -s -F document=@"${{ env.FINAL_ZIP }}" \
               "https://api.telegram.org/bot${TOKEN}/sendDocument" \
               -F chat_id="${CHAT}" \
               -F caption="imell_imupp [${{ env.BUILD_TIME }}]"
        fi
        
        ZIP [${{ env.BUILD_TIME }}]"
        fi

        
